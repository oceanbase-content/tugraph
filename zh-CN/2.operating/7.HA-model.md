# 部署高可用模式

> 此文档主要介绍了高可用模式的原理、准备工作、以及服务器的操作说明

## 原理

TuGraph 通过多机热备份来提供高可用模式（HA 模式）。在高可用模式下，对数据库的写操作会被同步到所有服务器上，这样即使有部分服务器宕机也不会影响服务的可用性。

在高可用模式下，多个 TuGraph 服务器组成一个备份组。每个备份组由三个或更多 TuGraph 服务器组成，其中某台服务器会作为`leader`，而其他复制组服务器则作为`follower`。写入请求由`leader`提供服务，该`leader`将每个请求复制同步到`follower`，并在请求同步到服务器后才能响应客户端。这样，如果任何服务器发生故障，其他服务器仍将具有到目前为止已写入的所有数据。如果`leader`服务器发生故障，其他服务器将自动选择出新的`leader`。

高可用模式仅企业版可用，开源社区版不含此功能。

## 准备工作

要启用高可用模式，用户需要：

- 三台及以上的 TuGraph 服务器实例。

- 获得一个具有高可用的 license 文件，具体请洽我们的经销商。
- 在启动 lgraph_server 时打开高可用模式，可以使用配置文件或者命令行将`enable_ha`选项设置为`true`。
- 设置正确的`rpc_port`，可通过配置文件或者命令行设置。

## 启动第一台服务器

第一台服务器在启动之后会将自己选举为`leader`，并组织一个只有自己的备份组。

第一台服务器需使用`--master ""`或`--master BOOTSTRAP`选项启动，具体取决于第一台服务器中是否已经具有数据。

- `--master "":` 如果第一台服务器中没有数据，用户可以直接使用`--master ""`选项启动服务器。
- `--master BOOTSTRAP:` 如果第一台服务器中已有数据（以`lgraph_import`工具导入或从非高可用模式的服务器传输得到），并且之前并未在高可用模式下使用，则用户应使用`BOOTSTRAP`选项在引导模式下启动服务器。在引导模式下，服务器在将新加入的服务器添加到备份组之前会将自己的数据复制到新服务器中，以使每个服务器中的数据保持一致。

启动第一台已经有数据的服务器的命令行示例如下：

```bash
$ ./lgraph_server -c lgraph.json --rpc_port 9090 --enable_ha true --master BOOTSTRAP
```

## 启动后续服务器

启动第一台服务器后，它将形成一个服务器备份组。但这是一个易受攻击的状态：如果服务器崩溃，服务将中断。在 TuGraph 中，在保证服务可用性的前提下，备份组最多可以承受 （N-1）/2 数量的服务器崩溃。因此，在一个备份组中必须至少有三台服务器，以在一个服务器丢失时保证服务可用性。

要将新服务器添加到备份组，应使用`--master {HOST：PORT}`选项，其中`HOST`可以是该备份组中已有的任何服务器的 IP 地址，而`PORT`是其 RPC 端口。例如：

```bash
./lgraph_server -c lgraph.json --rpc_port 9091 --enable_ha true --master 192.168.1.120:9090
```

此命令将启动一台高可用模式的 TuGraph 服务器，并尝试将其添加到包含服务器`192.168.1.120：9090`的备份组中。请注意，加入备份组需要服务器将其数据与备份组的`leader`服务器同步，此过程可能需要相当长的时间，具体取决于数据的大小。

## 停止服务器

当服务器通过`CTRL-C`下线时，它将通知当前的`leader`服务器，告知其从备份组中删除该下线的服务器。如果`leader`服务器下线，它将在下线前将`leader`身份权限传给另一台服务器。

如果服务器被终止或者与备份组中的其他服务器失去连接，则该服务器将被视为失败节点，`leader`服务器将在特定时限后将其从备份组中删除。

如果任何服务器离开备份组并希望重新加入，则必须从`--master {HOST：PORT}`选项开始，其中`HOST`是当前备份组中的某台服务器的 IP 地址。

## 重启服务器

不建议重新启动整个备份组，因为它会中断服务。如果需要，可以关闭所有服务器。但在重新启动时，必须首先启动最后一个关闭的服务器。

## 查看服务器状态

备份组的当前状态可以在 TuGraph 可视化工具、REST API 以及 Cypher 查询中获取。

在 TuGraph 可视化工具中，可以在 DBInfo 部分中找到备份组中的服务器及其角色列表。

使用 REST API 时，可以使用`GET /info/peers` 请求获取信息。

在 Cypher 中，使用`CALL dbms.listServers()`语句来查询当前备份组的状态信息。

## 高可用模式下数据同步问题

在高可用模式下，同一备份组中的不同服务器可能并不总是处于相同的状态。出于性能原因，如果请求已同步到超过一半的服务器，则`leader`服务器将认为该请求属于`committed`状态。尽管其余服务器最终将收到新请求，但服务器的状态不一致将持续一段时间。客户端也可能向刚刚重新启动的服务器发送请求，从而具有较旧的状态，并且正在等待加入备份组。

为了确保客户端看到一致连续的数据，特别是为了摆脱`反向时间旅行`问题（其中客户端读取比以前看到的状态更旧的状态），每个 TuGraph 服务器都会保持一个单调增加的数据版本号。备份组中数据版本号到数据库状态的映射全局一致，这意味着如果两台服务器具有相同的数据版本号，则它们必须具有相同的数据。响应请求时，服务器在响应中包含了其数据版本号。因此，客户端可以知道它看到了哪个版本。客户端可以选择发送此数据版本号以及请求。收到具有数据版本号的请求后，服务器会将数据版本号与其当前版本进行比较，如果其自己的版本低于请求的版本，服务器将拒绝该请求。此机制可确保客户端永远不会读取比以前较旧的状态。
